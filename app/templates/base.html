<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>NfoFetch - 影片刮削工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/modern-normalize@2.0.0/modern-normalize.min.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}" />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  </head>
  <body>
    <header class="nf-header">
      <div class="nf-container">
        <h1 class="nf-title">NfoFetch</h1>
        <p class="nf-subtitle">
          FastAPI + HTMX 影片刮削器（Jellyfin NFO，当前支持 javdb）
        </p>
      </div>
    </header>
    <main class="nf-main">
      <div class="nf-container">
        {% block content %}{% endblock %}
      </div>
    </main>
    <footer class="nf-footer">
      <div class="nf-container">
        <small>所有 NFO 与图片都会生成在对应视频文件所在的目录下。</small>
      </div>
    </footer>
    <script>
      // 使用 htmx 提供的 detail.elt 来判断是哪个元素发起请求
      document.addEventListener("htmx:beforeRequest", function (evt) {
        var elt = evt.detail && evt.detail.elt;
        if (!elt || !(elt instanceof HTMLElement)) return;
        if (elt.id !== "scrape-form") return;
        var result = document.getElementById("result");
        if (result) {
          result.innerHTML = "";
        }
        var btn = elt.querySelector("#scrape-button");
        if (btn instanceof HTMLButtonElement) {
          btn.disabled = true;
          btn.innerText = "正在刮削…";
        }
      });

      document.addEventListener("htmx:afterRequest", function (evt) {
        var elt = evt.detail && evt.detail.elt;
        if (!elt || !(elt instanceof HTMLElement)) return;
        if (elt.id !== "scrape-form") return;
        var btn = elt.querySelector("#scrape-button");
        if (btn instanceof HTMLButtonElement) {
          btn.disabled = false;
          btn.innerText = "开始刮削";
        }
      });

      // 写入按钮点击时的文字反馈
      document.addEventListener("htmx:beforeRequest", function (evt) {
        var elt = evt.detail && evt.detail.elt;
        if (!elt || !(elt instanceof HTMLElement)) return;
        if (elt.id !== "write-form") return;
        var btn = elt.querySelector("#write-button");
        if (btn instanceof HTMLButtonElement) {
          btn.disabled = true;
          btn.innerText = "正在写入…";
        }
      });

      document.addEventListener("htmx:afterRequest", function (evt) {
        var elt = evt.detail && evt.detail.elt;
        if (!elt || !(elt instanceof HTMLElement)) return;
        if (elt.id !== "write-form") return;
        var btn = elt.querySelector("#write-button");
        if (btn instanceof HTMLButtonElement) {
          btn.disabled = false;
          btn.innerText = "写入";
        }
      });

      // 简单的服务器文件浏览器
      (function () {
        function loadBrowser(path) {
          var params = new URLSearchParams();
          if (path) {
            params.set("path", path);
          }
          fetch("/browse?" + params.toString())
            .then(function (resp) {
              return resp.text();
            })
            .then(function (html) {
              var container = document.getElementById("file-browser-container");
              if (container) {
                container.innerHTML = html;
              }
            })
            .catch(function () {
              // ignore
            });
        }

        window.nfOpenFileBrowser = function () {
          var input = document.getElementById("video_path");
          var initial = input && input.value ? input.value : "";
          loadBrowser(initial);
        };

        window.nfBrowseTo = function (path) {
          loadBrowser(path);
        };

        window.nfSelectFile = function (path) {
          var input = document.getElementById("video_path");
          if (input) {
            input.value = path;
          }
          window.nfCloseFileBrowser();
        };

        window.nfCloseFileBrowser = function () {
          var container = document.getElementById("file-browser-container");
          if (container) {
            container.innerHTML = "";
          }
        };
      })();

      // 重命名格式：从 localStorage 恢复，并在变更或提交时保存
      (function () {
        var STORAGE_KEY = "nfofetch_rename_format";

        document.body.addEventListener("htmx:afterSwap", function (evt) {
          if (evt.detail && evt.detail.target && evt.detail.target.id === "result") {
            var input = document.getElementById("rename_format");
            if (input) {
              var saved = localStorage.getItem(STORAGE_KEY);
              if (saved !== null) {
                input.value = saved;
              }
            }
          }
        });

        document.body.addEventListener("input", function (evt) {
          var elt = evt.target;
          if (elt && elt.id === "rename_format") {
            localStorage.setItem(STORAGE_KEY, elt.value);
          }
        });

        document.body.addEventListener("htmx:beforeRequest", function (evt) {
          var elt = evt.detail && evt.detail.elt;
          if (!elt || elt.id !== "write-form") return;
          var input = document.getElementById("rename_format");
          if (input) {
            localStorage.setItem(STORAGE_KEY, input.value);
          }
        });
      })();
    </script>
  </body>
</html>

